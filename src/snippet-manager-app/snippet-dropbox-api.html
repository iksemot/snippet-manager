<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<dom-module id="snippet-dropbox-api">
  <template>
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/auth" active="{{isAuth}}"></app-route>
  </template>
  <script>
    class SnippetDropboxAPI extends Polymer.Element {
      static get is() { return 'snippet-dropbox-api'; }
      static get properties() {
        return {
          authToken: {
            type: String,
            value: ""
          },
          _dbx: {
            type: Object
          },
          dbx: {
            type: Object,
            notify: true
          },
          _queries: {
            type: Number,
            value: 0,
            observer: "onQueriesChange"
          },
          isLoading: {
            type: Boolean,
            value: false,
            notify: true
          },
          isReady: {
            type: Boolean,
            value: false,
            notify: true
          },
          error: {
            type: String,
            notify: true
          },
          isAuth: {
            type: Boolean
          }
        };
      }

      ready() {
        super.ready();
        if(this.isAuth) return this.parseAuthToken();
        if(!this.authToken && !this.isAuth) return this.authenticate();
      }

      parseAuthToken() {
        var authToken = window.location.hash.split("&")[0].split("=")[1];
        this.set("authToken", authToken);
        this.authorize();
      }

      authorize() {        
        var _queries = this._queries,
          self = this;
        this._dbx = new Dropbox({accessToken: this.authToken});
        this.dbx = new Proxy(this._dbx, {
          get(target, prop, receiver) {
            const originalMethod = target[prop];
            return function (...args) {
              self.set("_queries", ++_queries);
              self.set("error", "");
              return originalMethod.apply(target, args)
                .then((res) => {self.set("_queries", --_queries); return res;})
                .catch((err) => {
                  self.set("error", err.error.error_summary || err.error);
                  self.set("_queries", --_queries);
                  return err;
                })
            }
          }
        });
        this.set("isReady", true);
      }

      authenticate() {
        var dbx = new Dropbox({clientId: "1tixvq46rvmmufz"}),
          loc = window.location,
          url = dbx.getAuthenticationUrl(loc.protocol + "//" + loc.host + "/auth");

        window.location = url;
      }

      onQueriesChange(number) {
        this.set("isLoading", number > 0);
      }
    }

    window.customElements.define(SnippetDropboxAPI.is, SnippetDropboxAPI);


  </script>
</dom-module>
